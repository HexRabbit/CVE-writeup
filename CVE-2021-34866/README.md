# CVE-2021-34866
Linux kernel eBPF map type confusion lead to EoP.

The vulnability is discovered by Ryota Shiga ([@Ga_ryo_](https://twitter.com/ga_ryo_)) and I wrote a [blog post](https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/) explaining how I exploit this bug.

The exploit requires `CAP_BPF` capability. To run the exploit:

- use `setcap` to add the `CAP_BPF` capability to exploit binary 
- drop the privilege then run

`setcap` binary can be compiled from [libcap repo](https://git.kernel.org/pub/scm/linux/kernel/git/morgan/libcap.git/) or install by 

```bash
sudo apt install libcap2-bin
```

## Usage

Build for Ubuntu 21.04 (5.11.0-16.17):

```
make hirsute
sudo setcap cap_bpf+ep exploit
./exploit
```

Build for custom kernel (5.13.13) in `test/`:

```
make
cp exploit test/share
cd test
./run.sh
```

```
# (in qemu)
cp /mnt/exploit .
setcap cap_bpf+ep exploit; 
setsid cttyhack setuidgid 1000 exploit
```
